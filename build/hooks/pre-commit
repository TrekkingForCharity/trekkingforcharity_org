#!/usr/bin/env bash

#
# Pre-commit hook for TrekkingForCharity
# 
# This hook will:
# 1. Check for unapproved snapshots (.received.* files)
# 2. Run dotnet build
# 3. Run dotnet test
#
# If any step fails, the commit will be aborted.
#
# To skip this hook, use: git commit --no-verify
#

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo -e "${YELLOW}Running pre-commit checks...${NC}"
echo ""

# Check for unapproved snapshots
echo -e "${YELLOW}Checking for unapproved snapshots...${NC}"
RECEIVED_FILES=$(find . -name "*.received.*" -type f 2>/dev/null | grep -v "\.git/" | head -20)
if [ -n "$RECEIVED_FILES" ]; then
    echo -e "${RED}❌ Found unapproved snapshot files:${NC}"
    echo "$RECEIVED_FILES"
    echo ""
    echo -e "${YELLOW}Please approve or reject these snapshots before committing:${NC}"
    echo "  1. Run: ${GREEN}verify${NC} (if installed via build/install-verify-tool.sh)"
    echo "  2. Or manually:",
    echo "     - Review the .received.* file"
    echo "     - If approved: rename to .verified.*"
    echo "     - If rejected: delete and fix code"
    echo ""
    echo -e "${RED}Commit aborted. Resolve snapshots and try again.${NC}"
    exit 1
fi

echo -e "${GREEN}✓ No unapproved snapshots found${NC}"
echo ""

# Build
echo -e "${YELLOW}Building solution (Release)...${NC}"
if ! dotnet build --configuration Release; then
    echo -e "${RED}Build failed! Commit aborted.${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}Build successful!${NC}"
echo ""

# Run tests
echo -e "${YELLOW}Running tests...${NC}"
if ! dotnet test --no-build --verbosity normal; then
    echo -e "${RED}Tests failed! Commit aborted.${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}✓ All checks passed! Proceeding with commit.${NC}"
echo ""

exit 0
